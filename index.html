<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Welcome to join Suvin's technology gossip." />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Welcome to join Suvin's technology gossip.">
<meta property="og:url" content="https://suvinseptue.github.io/index.html">
<meta property="og:site_name" content="Welcome to join Suvin's technology gossip.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Welcome to join Suvin's technology gossip.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://suvinseptue.github.io/"/>





  <title> Welcome to join Suvin's technology gossip. </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Welcome to join Suvin's technology gossip.</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://suvinseptue.github.io/2017/02/07/mine/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Suvin">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Welcome to join Suvin's technology gossip.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Welcome to join Suvin's technology gossip." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/07/mine/" itemprop="url">
                  库存预估的一些叨叨
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-07T10:29:16+08:00">
                2017-02-07
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h2><p>目前广告系统对现有流量结构、流量库存没有量化指标，在广告投放、完成率排查、投放策略优化时没有理论数据支撑。因此需要一套库存系统，能够基于历史流量结构对广告投放进行模拟跑量,并输出流量结构。</p>
<p>通俗来讲就是有一堆品牌投放的单子，我们不知道这些单子能不能投完。</p>
<h2 id="面临的问题："><a href="#面临的问题：" class="headerlink" title="面临的问题："></a>面临的问题：</h2><h4 id="如何能够知道平台流量是否能够满足广告需求"><a href="#如何能够知道平台流量是否能够满足广告需求" class="headerlink" title="如何能够知道平台流量是否能够满足广告需求?"></a>如何能够知道平台流量是否能够满足广告需求?</h4><p>这个是我们需要解决的首要问题。我们需要做的是根据广告的投放需求整理出对应该需求的库存结构，再从库存结构中看是否满足广告的投放量，那么这个问题就变成建立供需关系模型的问题了。</p>
<h4 id="我们从需求方面先分析，品牌广告投放的需求有哪些？"><a href="#我们从需求方面先分析，品牌广告投放的需求有哪些？" class="headerlink" title="我们从需求方面先分析，品牌广告投放的需求有哪些？"></a>我们从需求方面先分析，品牌广告投放的需求有哪些？</h4><p>首先有我们都熟悉的地域、分类、平台，然后还有个频次控制（还有些别的需求暂不考虑）。如果订单只有地域、分类、平台的需求的话，那我们需要的库存模型就是分地域、分类别、分平台的VV库存结构，然后根据每一个TA的投放条件，按照维度占比去库存里面扣量即可，也就是分量算法。</p>
<p>但是品牌广告中有大量投放频次控制的订单，由于频次控制的特殊性，广告的投放量其实已经不是简单的通过VV去衡量了，而是通过UV，即库存的量度需要通过UV来表示。</p>
<p>也就是说，对于地域、分类、平台的维度，我们依然是采用分量算法去扣量，但是量度方面则变成了UV。</p>
<h4 id="根据需求，库存结构需要设计成什么样子了呢？"><a href="#根据需求，库存结构需要设计成什么样子了呢？" class="headerlink" title="根据需求，库存结构需要设计成什么样子了呢？"></a>根据需求，库存结构需要设计成什么样子了呢？</h4><p>一句话，我们需要维护的库存结构就是什么平台下什么地域什么分类我们有多少用户。</p>
<p>从而衍生出下面几个问题：</p>
<p><strong>频次控制下，如何将投放的CPM转化为所需要的用户？</strong></p>
<p><strong>既然库存量度是UV，那库存在维度重合情况下怎么办？</strong></p>
<p><strong>一个核心的问题，库存里量度是UV，那么什么时候这个用户算是被消耗掉了，不能用在其他投放的扣量上了？</strong></p>
<h2 id="说在前面："><a href="#说在前面：" class="headerlink" title="说在前面："></a>说在前面：</h2><h4 id="输入与输出"><a href="#输入与输出" class="headerlink" title="输入与输出"></a>输入与输出</h4><p>库存估算系统的输入：</p>
<ol>
<li>一堆TA的信息；</li>
</ol>
<p>现在库存估算系统能输出的数据有：</p>
<ol>
<li>一堆TA跑量后的总执行情况，缺量库存结构的分布。</li>
<li>由于跑量是以TA为单位跑的，因此可以输出某个TA在一堆TA的情况下的执行情况 </li>
<li>库存结构的数据，如iphone上海电影观看次数与人数的分布情况，观看次数中贴数与人数的分布情况</li>
<li>理想情况下的覆盖人数，模拟跑量的覆盖人数</li>
</ol>
<p>现在能想到的就这么多，应该还可以有待发掘的数据。</p>
<h4 id="数据准确度"><a href="#数据准确度" class="headerlink" title="数据准确度"></a>数据准确度</h4><p>目前估算的总体数据准确度为90%左右。</p>
<p>单个TA的估算准确度就有点飘了，这里有很大的优化空间的。</p>
<h4 id="大体思路"><a href="#大体思路" class="headerlink" title="大体思路"></a>大体思路</h4><ol>
<li>拿到该月参与估算的订单的投放信息TAn(1,2…n)与上个月的库存信息；</li>
<li>因为投放定向条件中有地域、分类、平台，因此库存也需要进行投放条件的划分，变成一个个维度的节点库存。</li>
<li>对TAn逐个进行扣量；根据当前TA的投放条件，找到对应维度的库存，根据维度占比算出该维度应消耗的量，逐个消耗节点库存；</li>
<li>当节点库存中的量大于当前TA的投放量时，将库存的量减去投放量作为新的库存；</li>
<li>当节点库存中的量小于当前TA的投放量时，这次则拿节点库存量作为投放量进行扣量，记<code>投放量减去库存量</code>作为缺量数据;</li>
<li>遍历完所有TA后，当节点库存&gt;0则说明当前维度流量有剩余，当节点库存&lt;=0时，则说明当前节点库存缺量。</li>
</ol>
<p>##思路详述</p>
<p>映射一个现实广告请求的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">TA1 频次1 投放量1000,</div><div class="line">TA2 频次2 投放量2000,</div><div class="line">TA3 频次3 投放量6000,</div><div class="line">TA4 频次4 投放量1000</div></pre></td></tr></table></figure>
<p>P1-1000个用户每个人看1个视频发起1次广告请求返回3个广告(TA1,TA2,TA3).</p>
<p>P2:该1000个用户又看了1个视频发起1次广告请求返回3个广告(TA2,TA3,TA4).</p>
<p>这里我们的库存数据就有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1000个用户，2000次3贴的广告请求，对应6000个广告曝光</div></pre></td></tr></table></figure>
<p>经过P1后:</p>
<p>TA1由于频次为1，因此它只能消耗了每个用户的1次请求中的1贴，即1000个广告曝光，那么这个时候库存还剩：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1000个用户，1000次2贴的广告请求对应2000个曝光，以及1000次3贴的广告请求对应3000个曝光</div></pre></td></tr></table></figure>
<p>TA2由于频次为2，因此它消耗了每个用户的2次请求中的1贴，即2000个曝光，那么库存还剩：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1000个用户，1000次1贴的广告请求对应1000个曝光，以及1000次2贴的广告请求对应2000个曝光</div></pre></td></tr></table></figure>
<p>TA3由于频次为3，因此它消耗了每个用户的2次请求中的1贴，即2000个曝光，那么库存还剩：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1000个用户，1000次1贴的广告请求对应1000个曝光</div></pre></td></tr></table></figure>
<p>TA4由于频次为4，所以它消耗了剩下的所有库存。</p>
<p>这个时候库存为0，TA3缺量4000</p>
<blockquote>
<p>这里的库存结构既有”人的库存“，又能表现流量库存，所以应用这个库存结构是比较合理的。</p>
</blockquote>
<p>这次做的库存估量就是基于上述扣量过程的模拟，应用到生产环境上还需要其他方面的考虑。</p>
<h4 id="库存结构设计"><a href="#库存结构设计" class="headerlink" title="库存结构设计"></a>库存结构设计</h4><p>“分类”、“城市”、“平台”等投放条件可以作为我们的库存维度，量度方面我们则是“观看广告次数”-“每次请求的广告贴数”-“人数”，量度里面的“观看广告次数”和“每次请求的广告贴数”其实也可以看成两种维度，真正的量度则是“人数”。</p>
<p>这里的维度是可拓展的，如果维度是相互独立（平台、地域）的话，则可以简单的采用分量算法计算库存；如果维度间具有关联性的话（分类），则需要额外考虑。</p>
<h2 id="实现细节与要点"><a href="#实现细节与要点" class="headerlink" title="实现细节与要点"></a>实现细节与要点</h2><h4 id="UV库存扣量"><a href="#UV库存扣量" class="headerlink" title="UV库存扣量"></a>UV库存扣量</h4><p>我们将上面的库存描述表示为此次设计的库存结构：</p>
<table>
<thead>
<tr>
<th>观看广告个数</th>
<th>贴次</th>
<th>请求次数</th>
<th>人数</th>
</tr>
</thead>
<tbody>
<tr>
<td>6</td>
<td>3</td>
<td>2</td>
<td>1000</td>
</tr>
</tbody>
</table>
<p>之前提到的扣量例子只是简单场景下的逻辑，现在我们举几个复杂的例子更深入地了解模拟过程的细节。</p>
<p><hr><br>库存结构：</p>
<table>
<thead>
<tr>
<th>观看广告个数</th>
<th>贴次</th>
<th>请求次数</th>
<th>人数</th>
</tr>
</thead>
<tbody>
<tr>
<td>50</td>
<td>5</td>
<td>10</td>
<td>10</td>
</tr>
</tbody>
</table>
<p>现在VV库存:10(人数)*50(观看广告个数)=500,UV库存10，对TA(频次：4，投放量：16)进行扣量:</p>
<ul>
<li>这里假设频次4的人均观看为4，那么需要4个人的4次/人广告观看；</li>
<li><p>在库存节点中扣除4个人的4次/人广告观看：</p>
<ul>
<li><p>首先我们从库存中拿出4个人来完成该TA的扣量,那么库存就分为两部分：<br>进行扣量的库存1：</p>
<p>  |观看广告个数|贴次|请求次数|人数|<br>|—–|—–|—-|—–|<br>|50|5|10|4|</p>
<p>  剩下的库存2：</p>
<p>  |观看广告个数|贴次|请求次数|人数|<br>|—–|—–|—-|—–|<br>|50|5|10|6|</p>
</li>
<li><p>该TA消耗的量为 4个人的4次/人 5贴中一贴的广告，那么库存1就变为 4次/人 4贴 和 6次/人 5贴，即：</p>
<p>  进行扣量的库存1：</p>
<p>  |观看广告个数|贴次|请求次数|人数|<br>|—–|—–|—-|—–|<br>|30|5|6|4|<br>|16|4|4|4|</p>
</li>
<li><p>再加上没有参与扣量的库存2之后，新的库存结构变为：</p>
<p>  |观看广告个数|贴次|请求次数|人数|<br>|—–|—–|—-|—–|<br>|50|5|10|6|<br>|30|5|6|4|<br>|16|4|4|4|</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>新的库存节点中VV量:6*50+4*30+4*16=484,VV库存是能对的上的,但是UV库存就变为16了，那明显是不对的。这里我们对进行扣量的库存1做一个合并操作，让UV库存一致。</p>
<p>  由于这里观看广告个数30的4人和观看广告个数16的4人，是同样的人，但是这样的表示方式会使得别的TA在扣量时会认为是不同的4个人，那么我们将这4人按照观看广告个数的占比划分为：46个观看广告个数里 每次看4帖的 16*4/(30+16) = 1.4人和 46个观看广告个数里 每次看 5贴的16*4/(30+16) = 2.6 人</p>
<p>  ,那么新的库存结构为：</p>
<p>  |观看广告个数|贴次|请求次数|人数|<br>|—–|—–|—-|—–|<br>|50|5|10|6|<br>|46|4|11.5|1.4|<br>|46|5|9.2|2.6|</p>
</li>
</ul>
<ul>
<li>新的库存节点中VV量:6*50+1.4*46+1.6*46=484,UV库存:6+1.4+2.6=10,现在VV和UV库存也都一致了。</li>
<li>只要保证对每一个TA扣量前后，库存的量都能保持一致的话，那么整个扣量过程就是准确的。</li>
</ul>
<p>这时候如果需要对另外一个TA2(频次：2 投放量 16，即需要8人)进行扣量的话，我们通过分量算法得出</p>
<p>观看广告个数50 维度里面需要扣4.8人，</p>
<p>观看广告个数46 贴次4 的维度里面需要扣1.12人，</p>
<p>观看广告个数 46 贴次5 的维度里面需要扣2.08人</p>
<p>然后依次对这三个维度进行上面的扣量过程,</p>
<p>观看广告个数50 扣量后库存：</p>
<table>
<thead>
<tr>
<th>观看广告个数</th>
<th>贴次</th>
<th>请求次数</th>
<th>人数</th>
</tr>
</thead>
<tbody>
<tr>
<td>50</td>
<td>5</td>
<td>-</td>
<td>1.2</td>
</tr>
<tr>
<td>48</td>
<td>4</td>
<td>-</td>
<td>0.8</td>
</tr>
<tr>
<td>48</td>
<td>5</td>
<td>-</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>观看广告个数46 贴次4 扣量后库存：</p>
<table>
<thead>
<tr>
<th>观看广告个数</th>
<th>贴次</th>
<th>请求次数</th>
<th>人数</th>
</tr>
</thead>
<tbody>
<tr>
<td>46</td>
<td>4</td>
<td>-</td>
<td>0.28</td>
</tr>
<tr>
<td>44</td>
<td>3</td>
<td>-</td>
<td>0.15</td>
</tr>
<tr>
<td>44</td>
<td>4</td>
<td>-</td>
<td>0.97</td>
</tr>
</tbody>
</table>
<p>观看广告个数46 贴次5 扣量后库存：</p>
<table>
<thead>
<tr>
<th>观看广告个数</th>
<th>贴次</th>
<th>请求次数</th>
<th>人数</th>
</tr>
</thead>
<tbody>
<tr>
<td>46</td>
<td>5</td>
<td>-</td>
<td>0.52</td>
</tr>
<tr>
<td>44</td>
<td>4</td>
<td>-</td>
<td>0.38</td>
</tr>
<tr>
<td>44</td>
<td>5</td>
<td>-</td>
<td>1.7</td>
</tr>
</tbody>
</table>
<p>综合一下的库存结构为：</p>
<table>
<thead>
<tr>
<th>观看广告个数</th>
<th>贴次</th>
<th>请求次数</th>
<th>人数</th>
</tr>
</thead>
<tbody>
<tr>
<td>50</td>
<td>5</td>
<td>-</td>
<td>1.2</td>
</tr>
<tr>
<td>48</td>
<td>5</td>
<td>-</td>
<td>4</td>
</tr>
<tr>
<td>48</td>
<td>4</td>
<td>-</td>
<td>0.8</td>
</tr>
<tr>
<td>46</td>
<td>5</td>
<td>-</td>
<td>0.52</td>
</tr>
<tr>
<td>46</td>
<td>4</td>
<td>-</td>
<td>0.28</td>
</tr>
<tr>
<td>44</td>
<td>3</td>
<td>-</td>
<td>0.15</td>
</tr>
<tr>
<td>44</td>
<td>5</td>
<td>-</td>
<td>1.7</td>
</tr>
<tr>
<td>44</td>
<td>4</td>
<td>-</td>
<td>1.35</td>
</tr>
</tbody>
</table>
<p>最后我们库存中剩余的VV总和为468，UV总和为10。</p>
<hr>

<p>下面罗列些扣量细节，不详述原理：</p>
<ul>
<li>实际参与计算的频次=Min(TA频次,观看次数/库存贴数)</li>
<li>当UV库存不满足TA的投放量时，则表现为缺量，并将UV库存作为投放量扣量；</li>
<li>产生的新库存节点累加过程在每一个TA扣量结束之后执行；</li>
</ul>
<h4 id="投放量转化"><a href="#投放量转化" class="headerlink" title="投放量转化"></a>投放量转化</h4><p>现在广告系统里面的投放量是曝光，而库存中的量是“人”，所以需要将曝光量(VV)转化为“需要多少人观看（即UV）”，这里转化关系中存在一个变量“频次”。举个例子：100的VV在频次为1的情况下需要100人观看；100的VV在频次为2的情况下需要x个看1次的观众和y个看2次的观众，总共需要（x+y）人。为了计算（x+y）的值，我们需要知道历史数据中看1次和看2次观众的平均观看次数z（1&lt;=z&lt;=2），通过vv/z我们就可以知道(x+y)的值。因此我们只需要算出平均观看次数即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">平均观看次数=sum(f(x))/总人数;</div><div class="line">f(x)=&#123;</div><div class="line">    观看x次的人数*x (x&lt;=频次);</div><div class="line">    观看x次的人数*频次 (x&gt;频次);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里我们通过历史数据算出1~500频次对应的人均观看次数(fqRate),以此进行投放量转化。</p>
<h4 id="多分类的人群重复"><a href="#多分类的人群重复" class="headerlink" title="多分类的人群重复"></a>多分类的人群重复</h4><p>频道分类作为库存维度之一，所表现的UV量是相互独立的，这样的库存对于投放单个分类的TA是适用的，但是对于投放多分类的TA来说，分类维度的UV库存是大于实际UV库存的，因为多分类的情况下用户是有重合度的，分类越多，重合度越大，预估的UV库存也就与实际值偏差越大。</p>
<blockquote>
<p>在加入分类因素前，预估的出来的缺量结果与实际值差20%，而将分类情况考虑进去之后，预估与实际差值在10%以内。</p>
</blockquote>
<p>因此，在对多分类TA跑量时，我们使用的UV库存应该是所投放的多分类维度下的UV库存，而不是简单的将分类UV库存相加；这里还有一个问题就是多分类维度的库存扣量完之后，如何关联地反应到实际库存结构中，作为其他TA跑量的库存呢？</p>
<p>如果我们在分类上建的维度是多分类的话，那么联动更新的算法肯定就更复杂了。</p>
<p>所以这里设计的是我们将单分类维度的库存作为Base库存，多分类库存则每次由Base库存衍生出来作为临时扣量库存，TA在多分类库存下扣的量由分量算法倒推回Base库存中做更新。这样就能做到联动更新了。衍生多分类库存算法有两个思路：</p>
<ul>
<li>Jaccard相似度：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">	Jaccard相似度</div><div class="line">判断两个集合是否相等，一般使用称之为Jaccard相似度的算法（后面用Jac(S1,S2)来表示集合S1和S2的Jaccard相似度）。举个列子，集合X = &#123;a,b,c&#125;，Y = &#123;b,c,d&#125;。那么Jac(X,Y) = 2 / 3 = 0.67。也就是说，结合X和Y有67%的元素相同。下面是形式的表述Jaccard相似度公式：</div><div class="line"></div><div class="line">Jac(X,Y) = |X∩Y| / |X∪Y|</div><div class="line"></div><div class="line">也就是两个结合交集的个数比上两个集合并集的个数。范围在[0,1]之间。</div></pre></td></tr></table></figure>
<ul>
<li>基于hyperloglog基数算法算出维度间的重合度；</li>
</ul>
<p>目前采用的是方法2。</p>
<h4 id="跨月TA的处理"><a href="#跨月TA的处理" class="headerlink" title="跨月TA的处理"></a>跨月TA的处理</h4><p>目前对于跨月投放的TA估算准确度非常低，会影响整体的估算流程。主要是因为目前估算的周期为1个月，在跨月的时候，人的观看次数会被认定为0，与线上逻辑有出入。</p>
<h2 id="日后待优化点"><a href="#日后待优化点" class="headerlink" title="日后待优化点"></a>日后待优化点</h2><ul>
<li>代码分模块：<ul>
<li>库存数量预估；根据历史库存波动情况预估当月库存，并输出库存结构用作模拟TA跑量</li>
<li>类别重合率模块；</li>
<li>TA预处理模块；处理频次转化，频道定向转化为类别定向；（7月份波动）</li>
<li>核心计算模块；</li>
</ul>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://suvinseptue.github.io/2017/01/10/ADX竞价请求响应时间优化——基于网络延迟的动态规划/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Suvin">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Welcome to join Suvin's technology gossip.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Welcome to join Suvin's technology gossip." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/10/ADX竞价请求响应时间优化——基于网络延迟的动态规划/" itemprop="url">
                  ADX竞价请求响应时间优化——基于网络延迟的动态规划
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-10T17:10:42+08:00">
                2017-01-10
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ADX竞价请求响应时间优化——基于网络延迟的动态规划"><a href="#ADX竞价请求响应时间优化——基于网络延迟的动态规划" class="headerlink" title="ADX竞价请求响应时间优化——基于网络延迟的动态规划"></a>ADX竞价请求响应时间优化——基于网络延迟的动态规划</h2><h3 id="背景描述："><a href="#背景描述：" class="headerlink" title="背景描述："></a>背景描述：</h3><p>目前对接的各家DSP网络状况不一,尽管对每家DSP请求的操作都是异步的,还是会导致主线程等待时间为<strong>max(ResponseTime)</strong>。不仅如此，长时间的响应时间延迟会导致HTTP连接无法释放，在大流量的情况下，HTTP连接池<strong>没有可用的连接</strong>，一些请求将会处于长时间的等待中，一些则会直接拒绝。因此，我们需要对DSP竞价请求的响应时间进行优化。</p>
<h3 id="方案概述："><a href="#方案概述：" class="headerlink" title="方案概述："></a>方案概述：</h3><ul>
<li><p>基于响应时间控制模式：</p>
<ul>
<li>程序中通过可接受的响应时间来控制主线程等待时间，未结束的请求需要主动进行释放操作。</li>
<li>此模式主要适用于强响应时间延迟控制的情景下，保证在一定响应时间内ADX返回广告，但是不保证参与竞价DSP的竞价率。</li>
<li>WaitTime &lt;= Acceptable Time.</li>
</ul>
</li>
<li><p>基于DSP响应率控制模式：</p>
<ul>
<li>程序中通过可接受的DSP响应率来控制主线程等待时间，当响应的DSP占比大于该变量时，结束等待，将未响应的请求主动释放。</li>
<li>此模式主要适用于DSP竞价率优先的情景下，保证主线程等待时间为大多数DSP的响应时间，但不保证竞价请求的响应时间。</li>
<li>WaitTime &lt;= Mostly DSP ResponseTime.</li>
</ul>
</li>
</ul>
<p>此方案可以减少长响应时间DSP的请求次数，有效地均衡各家DSP网络状况不一的情况，动态决定合理的等待时间。</p>
<h3 id="方案设计："><a href="#方案设计：" class="headerlink" title="方案设计："></a>方案设计：</h3><p>流程图如下：</p>
<p><img src="Bid Reqeust.pdf" alt="BidRequest FlowChar"></p>
<p>方案中，需要设置<code>Acceptable DSP Reponse Rate</code>与<code>Acceptable Time</code>变量。变量<code>Acceptable DSP Reponse Rate</code>控制等待DSP响应请求数占比，<code>Acceptable Time</code>为响应超时时间，同时也是<code>BaseDelayTime</code>的初始值。</p>
<h3 id="补充："><a href="#补充：" class="headerlink" title="补充："></a>补充：</h3><p>基于DSP响应率控制模式中，因为对<code>Acceptable DSP Reponse Rate</code>不停地迭代，会使竞价的DSP在近5次的请求中逐次变少，但是在参与竞价的DSP数量较多时，便不存在该问题。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://suvinseptue.github.io/2016/10/09/Paxos-Zookeeper/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Suvin">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Welcome to join Suvin's technology gossip.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Welcome to join Suvin's technology gossip." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/09/Paxos-Zookeeper/" itemprop="url">
                  Notes For Paxos
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-09T11:34:13+08:00">
                2016-10-09
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Paxos-Made-Simple"><a href="#Paxos-Made-Simple" class="headerlink" title="Paxos Made Simple"></a>Paxos Made Simple</h1><h2 id="Proposal-and-Acceptor"><a href="#Proposal-and-Acceptor" class="headerlink" title="Proposal and Acceptor"></a>Proposal and Acceptor</h2><h4 id="1-Prepare-phase"><a href="#1-Prepare-phase" class="headerlink" title="1. Prepare phase"></a>1. Prepare phase</h4><ul>
<li><p>A proposer selects a proposal number <em>n</em> and sends to request with number <em>n</em> to a majority of <em>acceptors</em></p>
</li>
<li><p>If an acceptor has receives a request numbern <em>n</em> large than that of any <em>prepare</em> request which it has already responded,then it respond to the request with promise not to accept any more request less than n and with the highest-number proposal it has accepted.</p>
</li>
</ul>
<h4 id="2-Accept-phase"><a href="#2-Accept-phase" class="headerlink" title="2. Accept phase"></a>2. Accept phase</h4><ul>
<li>A proposer receives a majority response to proposal <em>n</em>,then choose the highest-number proposal as accepted proposal and send <em>accept</em> request to a majority acceptor.</li>
<li>If an acceptor receives an <em>accept</em> request for a proposal numbered <em>n</em>,then it will accept it unless it has responded to a proposal which large then <em>n</em>.</li>
</ul>
<p>For performance optimization,Lamport suggests that Acceptor should respond proposal with abondon request after it accept one large than previous.</p>
<h2 id="Learner"><a href="#Learner" class="headerlink" title="Learner"></a>Learner</h2><h4 id="Learning-a-Choosen-value"><a href="#Learning-a-Choosen-value" class="headerlink" title="Learning a Choosen value"></a>Learning a Choosen value</h4><ul>
<li><p>Once an Acceptor accepted a proposal,it will respond to all learners,sending them the proposal.And it requires the sum of reponse of learners equals to the sum of acceptors and the sum of learners,for which make sure of a majority of learners would learn the proposal. </p>
</li>
<li><p>Besides,if learners want to know what the newly proposal is,it can have a proposer issue a proposal,using the altgorithm described above.</p>
</li>
</ul>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><ul>
<li><p>Each process plays roles of instance of the consensus algorithm,such like proposal,acceptor and learner.And algorithm choose a leader which plays the role of  distinguished proposal.</p>
</li>
<li><p>To guarantee that acceptor not to handle two proposal with same number,Acceptor will store the information during failures.</p>
</li>
</ul>
<h2 id="The-Implementation-of-State-Machine"><a href="#The-Implementation-of-State-Machine" class="headerlink" title="The Implementation of State Machine"></a>The Implementation of State Machine</h2><ul>
<li><p>A single state machine plays roles of leader server,to which client send command to.</p>
</li>
<li><p>As deterministic state machine,it implement a sequecnce of separate instances of the Paxos consensus algorithm to guarantee all the server execute command sequently.</p>
</li>
<li><p>While a new leader is elected,it will learn from the other server.</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://suvinseptue.github.io/2016/09/21/NoteOfAbstractQueueSynchronizer/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Suvin">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Welcome to join Suvin's technology gossip.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Welcome to join Suvin's technology gossip." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/21/NoteOfAbstractQueueSynchronizer/" itemprop="url">
                  Notes for AbstractQueueSynchronizer
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-21T14:31:11+08:00">
                2016-09-21
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Note for AbstractQueueSynchronizer</p>
<ul>
<li>Synchronizer process two kind of operation:<ol>
<li>acquire</li>
<li>release</li>
</ol>
</li>
</ul>
<ul>
<li>operation of <strong>acquire</strong> as:</li>
</ul>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if(synchronization state does not allow acquire)&#123;</div><div class="line">	enqueue current thread if not already queued;</div><div class="line">	block current thread</div><div class="line">&#125;</div><div class="line">dequeue current thread if it was queued;</div></pre></td></tr></table></figure>
</code></pre><ul>
<li><p>operation of <strong>release</strong> as:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">update synchronization state;</div><div class="line">if(state may permit a blocked thread to acquire)&#123;</div><div class="line">	unblock one or more queued threads;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Support for these operation require the coordination of these basic components:</p>
<ol>
<li>Atomically managing synchronization state;</li>
<li>Blocking and unblocking thread;</li>
<li>Maintaing queue;</li>
</ol>
</li>
<li><p>AbstractQueuedSynchronizer maintains synchronization state using only a single (32bit) int.</p>
</li>
<li><p><code>LockSupport.park</code> operation issued the problem of Thread.suspend while multiple <code>resume</code> called before <code>suspend</code> through not <em>counted</em>.</p>
</li>
</ul>
<h2 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h2><ul>
<li><p>There are two candicates to implemtent queue:</p>
<ul>
<li>MCS(Mellor-Crummey and Scott).In fact,I don’t know what it is.</li>
<li>CLH,a low-level locks that is used only in <em>spinlock</em>.</li>
</ul>
</li>
<li><p>The main additional modification needed to use CLH queues for blocking synchronizer is to provide an efficiency way for one node to locate its successor.</p>
<ul>
<li>Once it need change,in spinlocks,the node will be notified on next spin by its successor.</li>
<li>But in blocking queue,the node need to explicitly wake up its successor by <code>Lock.unpark</code>.</li>
</ul>
</li>
<li><p>To provide an atomically <code>insertion node</code> opertion.Because of the speciality of <code>locate</code> opertion,the node only need guarantee <code>entail</code> is atomic. </p>
</li>
</ul>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><ul>
<li><p>Concrete subclass need to implement <code>tryAcquire</code> and <code>tryRelease</code> through by inspecting and updating state.</p>
</li>
<li><p>Shared-mode,<code>ReentrantReadWriteLock</code>,will wake up multiple thread by cascading singals.</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://suvinseptue.github.io/2016/09/11/SpringSourceAnalysis/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Suvin">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Welcome to join Suvin's technology gossip.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Welcome to join Suvin's technology gossip." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/11/SpringSourceAnalysis/" itemprop="url">
                  Spring-Core核心逻辑源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-11T17:01:26+08:00">
                2016-09-11
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Spring-Core核心逻辑源码分析"><a href="#Spring-Core核心逻辑源码分析" class="headerlink" title="Spring-Core核心逻辑源码分析"></a>Spring-Core核心逻辑源码分析</h2><h4 id="初始化容器"><a href="#初始化容器" class="headerlink" title="初始化容器"></a><a></a>初始化容器</h4><ol>
<li>服务器容器根据配置文件（Tomcat:web.xml）加载ContextInitialListener事件:<code>ContextLoaderListener.contextInitialized()</code>;  </li>
<li>尝试获得parentContext;</li>
<li>根据parentContext <a href="#Initial ApplicationContext">初始化ApplicationContext</a>;</li>
<li>将<code>ApplicationRoot</code>为key，将context注册到servletContext中;</li>
<li>如果当前线程的ClassLoader为ContextClassLoader，则将context设置为currentContext;否则将context设置为perThreadContext;  </li>
</ol>
<p>####<a name="Initial ApplicationContext">初始化ApplicationContext</a> </p>
<ol>
<li>通过<code>BeanUtil.instantiateClass()</code>来创建ConfigurableWebApplicationContext；</li>
<li>设置context的id、parent、servletContext等属性（不晓得Id有什么用，代码还费了好几行获得best possible id😂）;</li>
<li>调用<code>ctx.refresh()</code>方法<a href="#start up Spring">构建Spring容器</a>构建Spring容器.</li>
</ol>
<blockquote>
<p>通过refresh方式初始化容器而不是init的方式，而且refresh中有通过beanFactory.getBean方式获取的对象，初始化阶段BeanFactory中是没有BeanDefinition的，因此这里我怀疑和tomcat的热部署有关系。</p>
</blockquote>
<p>####<a name="start up Spring">构建Spring容器</a></p>
<ol>
<li>根据信号<code>startupShutdownMonitor</code>来作同步，在同步代码块中进行refresh操作;  </li>
</ol>
<blockquote>
<p>Spring注释对startupShutdownMonitor有如下解释：<br>Synchronization monitor for the “refresh” and “destroy”.<br>即destroy方法必须等refresh方法执行完之后才能被调用;  </p>
</blockquote>
<ol>
<li><code>prepareRefresh()</code>:准备刷新，这里有个同步设置变量active，没看懂啥意思；</li>
<li><code>obtainRefreshBeanFactory()</code>：<a href="#init beanFactory">初始化</a>并获取BeanFactory;</li>
<li><code>prepareBeanFactory()</code>:初始化BeanFactory的依赖，包括ignoreDependency和硬代码registerDependency;Ignore掉的依赖通常是由别的方式进行注入，比如BeanFactory对象可以由BeanFactoryAware方式注入；获取并维护系统变量和环境变量</li>
<li><code>invokeBeanFactoryPostProcessor()</code>:根据BeanFactory是否为BeanDefinitionRegistry来调用BeanFactoryPostProcessor,再根据priority、order、nonOrder的顺序调用BeanPostProcessor。在服务器初始化阶段并没有注册BeanFactoryPostProcessor，也许在热部署阶段会执行吧；<em>也就是说，BeanFactoryPostProcessor是在BeanFactory初始化之后Bean对象初始化前执行的</em>(熟悉的BeanFactoryPostProcessor:<code>PropertyPlaceholderConfigure</code>)</li>
<li><code>registerBeanPostProcessor()</code>:根据<code>BeanFactory.getBeanNamesForType()</code>获取BeanPostProcessor，然后以Priority、Order、NonOrder的顺序注册到BeanPostProcessorList中。BeanPostProcessorList为ArrayList，因此执行顺序为：Priority&gt;Order&gt;NonOrder；</li>
<li><code>initMessageSource()</code>:获取MessageSource对象，默认为DelegatingMessageSource;</li>
<li>接下来是注册广播事件监听器、调用子类的onRefresh方法、注册应用监听器；</li>
<li><code>finishBeanFactoryInitialization()</code>：初始化所有not-lazy-init Bean。也是SpringCore的<a href="#spring-core">核心代码</a>；</li>
<li><code>finishRefresh</code>:触发加载完成事件；</li>
</ol>
<h4 id="初始化BeanFactory"><a href="#初始化BeanFactory" class="headerlink" title="初始化BeanFactory"></a><a name="init beanFactory">初始化BeanFactory</a></h4><ol>
<li>清空已加载的Bean；</li>
<li>创建一个内部BeanFactory；</li>
<li>自定义BeanFactory配置：setAllowBeanDefinitionOverriding、setAllowEagerClassLoading、setAllowCircularReferences、setAllowRawInjectionDespiteWrapping</li>
<li><code>loadBeanDefinitions()</code>:遍历Resources中的Xml定义的<a href="#loadBeanDefinition">bean加载</a>至BeanDefinition；</li>
</ol>
<h4 id="Bean加载"><a href="#Bean加载" class="headerlink" title="Bean加载"></a><a name="loadBeanDefinition">Bean加载</a></h4><ol>
<li>根据Resource生成Document对象；根据Document的Element的nodeName属性来处理Bean：<ul>
<li>如果nodeName为Import，则执行<code>importBeanDefinitionResource</code>操作加载import-resource定义的bean：</li>
<li>如果nodeName为Alias，则将BeanName与Alias关联注册；</li>
<li>如果nodeName为Bean，则根据属性解析Element生成BeanHolder，将BeanName与BeanDefinition注册到BeanDefinitions缓存中;</li>
<li>如果nodeName为Beans,则跳至1.处理Beans中的Bean；</li>
</ul>
</li>
</ol>
<h4 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a><a name="spring-core">核心代码</a></h4><ol>
<li>1.<code>finishBeanFactoryInitialization</code>-&gt;<code>preInstantiateSingletons()</code>:同步获取缓存中的<code>beanDefinitionNames</code>，放到局部变量中;</li>
<li>遍历beanDefinitionName,调用<a href="#get bean">getBean()</a>初始化Bean;</li>
</ol>
<h5 id="getBean"><a href="#getBean" class="headerlink" title="getBean()"></a><a name="get bean">getBean()</a></h5><ol>
<li>首先尝试从singletonObjects、earlySingletonObjects的缓存中获取对象;</li>
<li>如果对象不为空，则调用<code>getObjectForBeanInstance()</code>方法通过FactoryBean或者对象本身的方式获得Bean对象;</li>
<li>如果对象不为空，则尝试在ParentBeanFactory中获得对象，并返回；</li>
<li>如果ParentBeanFactory对象中没有获得Bean对象，则读取BeanDefinistions缓存中获得该Bean的Definition对象；</li>
<li>拿到BeanDefinition对象后，遍历该对象的dependsOn属性，并将该BeanName与DependsOn的对象Name注册dependentBeanMap中，然后调用<a href="#get bean">getBean()</a>来实例化DependsOn的对象。这里会根据dependentBeanMap来检查是否存在循环依赖，(<em>Spring对Bean属性之间的循坏依赖是有解决方案的，不清楚这里的循坏依赖为什么会直接抛出异常</em>)；</li>
<li>实例化DependsOn对象后，再根据Bean的Scope属性创建对象，Singleton方式和prototype方式的区别在于Singleton对象在创建的时候首先会在缓存中取对象，如果不存在再<a href="#createBean">createBean()</a>创建一个新的对象放到singletonObjects和earlySingletonObjects中，而prototype类型的则不不会在缓存中取对象，直接创建新对象.</li>
<li><code>getObjectForBeanInstance()</code><br>:拿到Bean对象之后，确定Bean是否为FactoryBean，如果是则需要通过FactoryBean的方式获取bean，否则直接返回bean.</li>
</ol>
<h5 id="createBean"><a href="#createBean" class="headerlink" title="createBean()"></a><a name="createBean">createBean()</a></h5><ol>
<li>在初始化前，首先调用<code>resolveBeanClass()</code>确保beanClass已经加载到ClassLoader里面；这里会去看BeanDefinition中是否有指定的class，如果没有，则会调用<code>ClassUtils.forName()</code>在ClassLoader容器中加载class；</li>
<li>确保class已经加载完成之后，执行<code>resolveBeforeInstantiation()</code>，尝试通过<code>InstantiationAwareBeanPostProcessor</code>来创建Bean，如果Bean创建成功，则调用<code>applyBeanPostProcessorsAfterInitialization()</code>应用Bean后处理器，并返回Bean对象；(<em><code>InstantiationAwareBeanPostProcessor</code>这个里面虽然可以返回null，但是返回null之后，Spring容器会认为没有创建bean，重新创建bean</em>)</li>
<li>如果<code>InstantiationAwareBeanPostProcessor</code>返回null,调用<a href="#doCreateBean">doCreateBean()</a>真正的创建Bean对象.(os:创建个对象前戏真长😴)</li>
</ol>
<h5 id="doCreateBean"><a href="#doCreateBean" class="headerlink" title="doCreateBean()"></a><a name="doCreateBean">doCreateBean()</a></h5><ol>
<li>通过<code>createBeanInstance()</code>创建Bean实例。该方法首先在resolvedConstructor的一系列变量中找到缓存的Constructor，否则找到一个FastConstructor(找最合适的过程比较冗长，这里省略这么多字)，再根据是否有OverrideMethod，来选择通过Reflect的形式还是CGlib的形式创建对象；</li>
<li>Bean实例化出来之后，调用<code>applyMergedBeanDefinitionPostProcessors()</code>来执行BeanPostProcessor；</li>
<li>这时候属性还是空的，在注入属性时会发生循环依赖的问题，因此这里会判断是否允许循环依赖，如果允许的话将bean的引用通过<code>ObejctFactory</code>工厂的方式暴露出去；</li>
<li><code>populateBean()</code>，遍历并且注入依赖。</li>
<li><code>initializeBean()</code>，调用Bean的初始化方法，init啦，afterPropertiesSet啦。</li>
</ol>
<p><hr></p>
<h4 id="额外补充-实例Bean是什么时候变成Proxy的呢？"><a href="#额外补充-实例Bean是什么时候变成Proxy的呢？" class="headerlink" title="额外补充:实例Bean是什么时候变成Proxy的呢？"></a>额外补充:实例Bean是什么时候变成Proxy的呢？</h4><p>通过<a href="#doCreateBean">doCreateBean()</a>的步骤1.出来的实例这个时候还是对象本身，而Spring暴露出来的Bean又都是以代理形式出现的，那么Spring是什么时候对实例进行代理wrap的呢，通过Debug看到在<code>applyMergedBeanDefinitionPostProcessors()</code>阶段，<br>AbstractAutoProxyCreator以BeanPostProcessor的方式对实例出来的Bean进行AutoProxy，通过判断该实例的Class对象是否有Interfaces，如果有则通过JDK Dynamic的方式代理，否则使用CGlib.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://suvinseptue.github.io/2016/07/08/JVM/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Suvin">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Welcome to join Suvin's technology gossip.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Welcome to join Suvin's technology gossip." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/08/JVM/" itemprop="url">
                  Note for JVM
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-08T11:01:53+08:00">
                2016-07-08
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>NIO引入Channel和Buffer的IO方式，通过DirectByteBuffer作为对外内存的引用，避免了Java堆与native来回复制内存</li>
<li>serial、parnew等新生代 基于compact的垃圾回收算法采用的内存分配是Bump the Pointer</li>
<li>CMS等基于Mark-Sweep算法的收集器采用的是Free List</li>
<li>JDK1.7中，String#intern()方法会将字符串对象的引用存放到常量池中，而不是字符串对象。</li>
<li>intern中字符串个数为1007,当常量池中有大量字符串时，会严重影响系统性能</li>
<li>现在，服务端YoungGeneration的收集器是ParNew,OldGeneration的收集器的是CMS。</li>
<li>JDK1.7以后支持的GC收集器G1,G1 split the memory into many fixed size region.Each region size is 1Mb-30Mb,and the max count of region is 2000.The Young Generation and the Old Gernaration share the same memory.</li>
<li>类的初始化阶段，编译器会收集该类所有的静态语句块，组装成<clinit>().</clinit></li>
<li>父类静态的初始化始终先于子类，因此会先执行父类的<clinit>().</clinit></li>
<li>static{}语句块中，只允许对出现在其之后的静态变量赋值，不允许访问. </li>
<li>类加载的双亲委派模型可以有效的防止类被重复加载。</li>
<li>上传到服务器器临时服务监控代码~~牛逼哄哄的样子</li>
<li>volatile通过汇编的lock操作保证先于此变量的代码不会乱序</li>
<li>乱序只会发生在多线程（多CPU）情况下</li>
<li>the long and double variable is not atomic.But the major jvm provider had implement it as atomic.Don’t worry about it.</li>
<li>An ordering relationship should meet the follow rules:<ol>
<li>Program Order Rule:within thread,all operation will process order by writing ascend.</li>
<li>Monitor Lock Rule:a unlock operation happend before lock operation which are same monitor lock.</li>
<li>Volatile Variable Rule:a write to volatile happend before a read to volatile.</li>
<li>Transitivity:if A happend before B,and B happend before C,then A happend before C.</li>
</ol>
</li>
<li>We can use synchroize operation through Synchronize block and java.util.concurrent.Before jdk1.6,the reentrylock play more performance than the primitive keyword ‘Synchronize’.The java.util.concurrent implements synchronize with a series of Unsafe API,it act as a light weight operation.</li>
<li>After jdk1.6,the Hotspot team done lots of work to optimize the synchronization:<ol>
<li>self-spinning lock: in the scenes of synchronization,a plenty of operation only need a short pause.Without self-spinning,current thead have to be blocked until another thread invoke notify or notifyall instruction.Self-spinning replace with loop which can skip the await-notify process.</li>
<li>remove lock:For example,jvm will optimize the concat of string by StringBuffer.append.As we konw,StringBuffer.append is a synchronized function,but lots of string concat needn’t be synchronized,the jvm will remove this synchronization during building.</li>
<li>Light-weigh lock: to do synchroinize by CAS.</li>
<li>Bias-lock: biase do work in the same thread witch needn’t use synchronize.</li>
</ol>
</li>
<li>Program cannot handle Error exception,and it will kill the current Thread instead.</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  

          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.png"
               alt="Suvin" />
          <p class="site-author-name" itemprop="name">Suvin</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Suvin</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  




  
  

  

  

  

  


</body>
</html>
